@page
@model Sorling.SqlConnAuthWeb.areas.sqlconnauth.pages.ThemeSwitcherJS
@{
    Layout = null;
    this.Response.ContentType = "application/javascript";
}
(function () {
@if (Model.SQLAuthOptions.UseThemeSwitcher())
{
    <text>
        const THEME_KEY = '@(Model.SQLAuthOptions.ThemeSwitcherLocalStorageName)';
        const themeSelect = document.getElementById('theme-switcher-select');
        const forcedTheme = document.documentElement.getAttribute('data-bss-forced-theme');

        function getStoredTheme() {
            return localStorage.getItem(THEME_KEY);
        }
        function setStoredTheme(theme) {
            localStorage.setItem(THEME_KEY, theme);
        }
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        function getPreferredTheme() {
            if (forcedTheme) return forcedTheme;
            const storedTheme = getStoredTheme();
            if (storedTheme) return storedTheme;
            return 'system';
        }
        function applyTheme(theme) {
            let themeToSet = theme;
            if (theme === 'system') {
                themeToSet = getSystemTheme();
            }
            document.documentElement.setAttribute('data-bs-theme', themeToSet);
            document.documentElement.setAttribute('data-theme', themeToSet);
        }
        function setTheme(theme) {
            setStoredTheme(theme);
            applyTheme(theme);
            if (themeSelect) themeSelect.value = theme;
        }
        if (themeSelect) {
            themeSelect.addEventListener('change', function() {
                setTheme(this.value);
            });
        }
        // On system theme change, update if system is selected
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
            if (getStoredTheme() === 'system' || !getStoredTheme()) {
                applyTheme('system');
            }
        });
        // On page load
        document.addEventListener('DOMContentLoaded', function() {
            const theme = getPreferredTheme();
            setTheme(theme);
        });
    </text>
}
})();